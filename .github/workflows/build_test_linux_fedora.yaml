name: Build & Test Fedora

on:
  push:
    branches:
      - master

## Build ##

jobs:
  linux-fedora:
    name: Build on Fedora Linux
    runs-on: ubuntu-latest
    container: sogno/dpsim:dev
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Create Build Environment
      run: mkdir build

    - name: Configure CMake
      shell: bash
      working-directory: ${{ github.workspace }}/build
      run: cmake $GITHUB_WORKSPACE

    - name: Build every target
      shell: bash
      working-directory: ${{ github.workspace }}/build
      run: cmake --build .
      env:
        MAKEFLAGS: "-j2"

    - name: Cache build directory
      uses: actions/cache@v2
      with:
        path: ${{ github.workspace }}/build
        key: build-cache-fedora-${{ github.sha }}

## Tests ##

  test-binaries:
    name: Execute Example
    runs-on: ubuntu-latest
    container: sogno/dpsim:dev
    needs: [linux-fedora]
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Restore Cache
      uses: actions/cache@v2
      with:
        path: ${{ github.workspace }}/build
        key: build-cache-fedora-${{ github.sha }}

    - name: Run Binaries
      run: ./build/Examples/Cxx/WSCC_9bus_mult_coupled